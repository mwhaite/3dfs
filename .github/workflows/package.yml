name: Build Packages

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  linux-packages:
    name: Build Linux Artifacts
    runs-on: ubuntu-latest
    env:
      APPIMAGE_EXTRACT_AND_RUN: "1"
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Configure runtime directory
        run: |
          echo "XDG_RUNTIME_DIR=${RUNNER_TEMP}/xdg-runtime" >> "$GITHUB_ENV"
          mkdir -p "${RUNNER_TEMP}/xdg-runtime"
          chmod 700 "${RUNNER_TEMP}/xdg-runtime"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder desktop-file-utils libfuse2 patchelf
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install '.[build123d]'

      - name: Download appimagetool
        run: |
          curl -L https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -o appimagetool.AppImage
          chmod +x appimagetool.AppImage

      - name: Build AppImage
        run: python scripts/build_appimage.py --appimagetool $PWD/appimagetool.AppImage

      - name: Build Debian package
        run: python scripts/build_deb_package.py

      - name: Build Flatpak bundle
        run: python scripts/build_flatpak.py --user --disable-rofiles-fuse

      - name: Archive Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            dist/linux/*.AppImage
            dist/deb/*.deb
            dist/flatpak/*.flatpak
          if-no-files-found: error

  macos-packages:
    name: Build macOS Bundle
    runs-on: macos-13
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip wheel
          pip install .
          pip install -r packaging/macos/requirements.txt

      - name: Build macOS bundle
        run: python scripts/build_macos_bundle.py

      - name: Archive macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-packages
          path: |
            dist/macos/*.dmg
            dist/macos/*.app
          if-no-files-found: error

  windows-packages:
    name: Build Windows Bundle
    runs-on: windows-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip wheel
          pip install .[build123d] cx_freeze

      - name: Build Windows bundle
        shell: pwsh
        run: python scripts/build_windows_dist.py

      - name: Archive Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-packages
          path: |
            dist/windows/**/*.zip
          if-no-files-found: error
